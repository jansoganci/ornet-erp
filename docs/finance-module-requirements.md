# Finance Module - Complete Requirements Specification

**Document Version:** 2.0
**Date:** February 9, 2026
**Status:** Requirements Finalized - Ready for Data Model Design
**Supersedes:** finance-module-analysis.md (v1.0)

---

## 1. Business Context

### Company Profile
- Turkish security/alarm company
- ~1M TRY annual revenue
- 2,500+ SIM cards in the field
- Mixed accounting: official (resmi) + unofficial (gayriresmi)
- Current system: 100% manual Excel tracking

### Current Daily Volume
- ~60-70 financial entries per day in Excel
- Breakdown:
  - ~20/day: subscription payments (will be AUTO-GENERATED by ERP)
  - ~10-15/day: one-time income (installation, service, equipment sales)
  - ~25-35/day: expenses (materials, fuel, bills, etc.)
- **After ERP automation: ~35-50 manual entries/day remain**

### What This Module Replaces
The monthly Excel spreadsheet:
```
DATE | CUSTOMER | PAYMENT METHOD | JOB TYPE | COST | INPUT VAT | SALES | SALES VAT | TOTAL | PROFIT | VAT
```
Every row becomes a `financial_transactions` record. Same data, connected to the ERP.

---

## 2. Revenue Streams

### 2.1 Subscription Income (ALREADY BUILT)
- Monthly/yearly recurring fees from alarm monitoring, camera, internet services
- Auto-generated payment records in `subscription_payments` table
- Supports: card, cash, bank transfer
- Has `should_invoice` flag (official vs unofficial)
- Has `payment_vat_rate` for per-payment VAT control
- **No new work needed — feeds into P&L dashboard via view**

### 2.2 SIM Card Rental Income
- SIM cards rented to customers (monthly or annual basis)
- Separate revenue line from subscriptions
- Not every customer has a SIM card — it's optional
- Some cards are active (payments coming in), some inactive (not in use)
- Bulk corporate rentals exist (multiple cards per customer)
- `simCards` module already exists for inventory tracking

**Decision:** SIM card billing handled as subscriptions (same system, different tag/type). Annual billing = one transaction in the billing month, not split into 12 records. No separate billing system needed.

### 2.3 One-Time Sales Income
- Equipment sales (alarm panels, cameras, sensors)
- Installation charges (montaj)
- Service charges (servis — repairs, battery replacement, etc.)
- Maintenance charges (bakim)

**Current flow:**
1. Quote/teklif sent to customer (quote module NOT built yet)
2. Customer approves
3. Work order created → materials purchased/allocated
4. Installation/service performed
5. Quality check
6. Invoice generated immediately after completion
7. Financial transaction recorded

**MVP approach:** Manual entry in `financial_transactions` with optional `work_order_id` link. Full automation (work order → invoice) is Phase 2.

### 2.4 Service Revenue
- Battery replacements, repairs, system upgrades
- One-time charges linked to work orders
- Same entry flow as 2.3

---

## 3. Expense Categories

### Fixed Categories (10)

| # | Category (EN) | Category (TR) | Examples |
|---|---|---|---|
| 1 | Material / Equipment (COGS) | Malzeme / Ekipman | Alarm panels, cameras, cables, sensors |
| 2 | SIM Card Operator Bills | Operator Faturalari | Turkcell, Vodafone monthly bills |
| 3 | Fuel | Yakit | Vehicle fuel for field technicians |
| 4 | Payroll | Personel Maasi | Employee salaries |
| 5 | Rent / Office | Kira | Office rent |
| 6 | Utilities | Elektrik / Su / Dogalgaz | Office utility bills |
| 7 | Communication | Haberlesme | Phone plans, internet |
| 8 | Vehicle Expenses | Arac Giderleri | Maintenance, insurance, tires |
| 9 | Fixed Assets | Demirbas | Equipment, tools, depreciation |
| 10 | Other | Diger | Anything not in above categories |

### Custom Categories
- User can add new categories at any time
- Custom categories stored in a `expense_categories` table
- Each category has: id, name_tr, name_en, icon (optional), is_system (bool), is_active (bool)
- System categories (1-10) cannot be deleted, only deactivated

### IMPORTANT: What is NOT an Expense Category
- **VAT payments (odenen KDV)** — this is a liability settlement, not an expense
- **Withholding tax (stopaj)** — this is a balance sheet item, not an expense
- Including these as expenses would inflate costs and deflate profit on P&L
- VAT is computed automatically on each transaction, not entered as a separate expense

---

## 4. VAT System

### Core Rules
- Standard VAT rate: 20% (Turkey, 2025-2026)
- Output VAT (Sales VAT): always applies to official income
- Input VAT (Purchase VAT): optional — depends on whether purchase has an invoice

### Official vs Unofficial (Resmi vs Gayriresmi)

**Income:**
- `should_invoice = true` → official income, output VAT calculated and collected
- `should_invoice = false` → unofficial income, internal tracking only, no VAT

**Expenses:**
- `has_invoice = true` → official purchase, input VAT = 20%, deductible
- `has_invoice = false` → unofficial purchase, input VAT = 0%, not deductible

### VAT Calculation
```
Monthly Output VAT = SUM(output_vat) from all official income transactions
Monthly Input VAT  = SUM(input_vat) from all official expense transactions
Net VAT Payable    = Output VAT - Input VAT
```

### Calculation Examples

**Official expense + Official sale:**
```
Expense: 1,000 TL + 200 TL input VAT = 1,200 TL paid
Sale:    2,000 TL + 400 TL output VAT = 2,400 TL collected
Net VAT: 400 - 200 = 200 TL payable
Profit:  2,000 - 1,000 = 1,000 TL
```

**Unofficial expense + Official sale:**
```
Expense: 1,000 TL + 0 TL input VAT = 1,000 TL paid
Sale:    2,000 TL + 400 TL output VAT = 2,400 TL collected
Net VAT: 400 - 0 = 400 TL payable (full amount, no deduction)
Profit:  2,000 - 1,000 = 1,000 TL
```

### The `should_invoice` Pattern
Already implemented in subscriptions module. Same pattern applies to ALL transaction types:
- Subscriptions: `should_invoice` flag on `subscription_payments`
- One-time sales: `should_invoice` flag on `financial_transactions`
- Expenses: `has_invoice` flag on `financial_transactions` (controls input VAT)

---

## 5. Currency System

### Rules
- **One-time sales / quotes:** priced in USD by default
- **Subscriptions:** priced in TRY (already built this way)
- **Expenses:** entered in TRY (local costs)
- User can override currency on any transaction

### Dual Storage (Mandatory)
Every financial transaction stores:
- `amount_original` — the business amount (e.g., 500 USD or 1,500 TRY)
- `original_currency` — 'USD' or 'TRY'
- `amount_try` — the legal/invoice amount, always in TRY
- `exchange_rate` — TCMB rate used for conversion (null if already TRY)

### Exchange Rate Source
- TCMB (Central Bank of Turkey) EVDS API — free, requires API key
- Daily USD/TRY sell rate
- For invoicing: use previous business day's closing sell rate
- Weekend/holiday: use last available business day rate

### Exchange Rate Table: `exchange_rates`
```
id, currency, buy_rate, sell_rate, effective_rate, rate_date, source, created_at
```
- `effective_rate` = sell rate (used for invoicing)
- Historical rates stored permanently
- Daily sync via TCMB API (can be manual trigger initially, cron later)

### Conversion Example
```
Sale Price:     $500 USD
TCMB Sell Rate: 45.50 TRY (Feb 7, 2026)
Base Amount:    22,750 TRY
VAT (20%):      4,550 TRY
Invoice Total:  27,300 TRY
```

---

## 6. Payment Methods

### Supported Methods
- **Card (Kredi Karti)** — always requires official invoice
- **Cash (Nakit)** — user chooses official or unofficial
- **Bank Transfer (Havale/EFT)** — user chooses official or unofficial

### Payment Method Rules for Income
| Method | `should_invoice` | VAT | Invoice Required |
|---|---|---|---|
| Card | Always TRUE (forced) | Always calculated | Yes, always |
| Cash | User choice | If invoiced: yes. If not: no | User decides |
| Bank Transfer | User choice | If invoiced: yes. If not: no | User decides |

### Reference Tracking
- Bank transfers: optional `reference_no` (dekont no)
- Card payments: linked to payment method via `payment_method_id` (on subscriptions)
- Cash: no reference needed

---

## 7. Work Order to Financial Transaction Link

### Current State
- Work orders track work performed (materials used, labor, status)
- No financial data on work orders
- Invoicing done manually outside the system

### MVP (Phase 1)
- Manual entry in `financial_transactions` with optional `work_order_id` foreign key
- User completes work order → goes to finance → creates income transaction → links it
- Simple, no automation

### Phase 2 (Future)
- "Generate Invoice" button on completed work orders
- Auto-calculates: materials cost + labor + service charge
- USD → TRY conversion (TCMB rate)
- VAT calculation
- Send to Parasut API
- Auto-create `financial_transactions` record
- Update work order with `invoice_no`

### Full Future Pipeline (Phase 3+)
```
Quote (teklif) → Approval → Work Order → Materials → Installation
→ Quality Check → Generate Invoice → Parasut → Financial Transaction
```

---

## 8. SIM Card Financial Integration

### Current State
- `simCards` module exists (inventory tracking)
- Has `cost_price` and `sale_price` fields
- No recurring billing system for SIM cards

### Decision: SIM Billing = Subscriptions
- SIM card rentals are handled as subscriptions in the existing subscription system
- Tagged differently (service_type or subscription_type distinction)
- Annual SIM rental = one transaction in the billing month (not split into 12)
- Per-card profitability = rental fee - operator cost (tracked in simCards module)

### Bulk Corporate Rentals
- One subscription per corporate client covering N cards
- Subscription amount = N x per-card rental price
- Cards linked to the customer in simCards module

---

## 9. P&L Dashboard

### Data Sources (No Duplication)
The P&L view UNIONs data from existing tables:

| Source | Type | Auto/Manual |
|---|---|---|
| `subscription_payments` (status=paid) | Recurring revenue | Auto-generated |
| `financial_transactions` (direction=income) | One-time revenue | Manual entry |
| `financial_transactions` (direction=expense) | Expenses | Manual entry |

### P&L Structure (Monthly)
```
REVENUE
  Subscription Income:         XXX TRY
  One-Time Sales:              XXX TRY
  Service Revenue:             XXX TRY
  ─────────────────────────────────────
  Total Revenue:               XXX TRY

COST OF GOODS SOLD (COGS)
  Materials / Equipment:       XXX TRY
  SIM Card Operator Bills:     XXX TRY
  ─────────────────────────────────────
  Total COGS:                  XXX TRY

GROSS PROFIT:                  XXX TRY

OPERATING EXPENSES
  Payroll:                     XXX TRY
  Fuel:                        XXX TRY
  Rent / Office:               XXX TRY
  Utilities:                   XXX TRY
  Communication:               XXX TRY
  Vehicle:                     XXX TRY
  Fixed Assets:                XXX TRY
  Other:                       XXX TRY
  ─────────────────────────────────────
  Total Operating Expenses:    XXX TRY

NET PROFIT (before tax):       XXX TRY

VAT SUMMARY
  Output VAT (collected):      XXX TRY
  Input VAT (deductible):      XXX TRY
  Net VAT Payable:             XXX TRY
```

### Period Handling
- Each transaction has a `period` field (YYYY-MM)
- Transactions recorded when they OCCUR (accrual basis), not when cash moves
- Subscription payments already use `payment_month` for this
- P&L reports are always period-based

### Dashboard Features (MVP)
- Monthly P&L summary (current month)
- Month-over-month comparison (this month vs last month)
- Revenue breakdown by source (subscriptions, one-time, services)
- Expense breakdown by category
- VAT summary

---

## 10. Tables Architecture (Summary)

### New Tables (MVP)
| Table | Purpose |
|---|---|
| `financial_transactions` | Core ledger — every income and expense entry |
| `expense_categories` | Configurable expense categories |
| `exchange_rates` | Daily TCMB exchange rates |

### Existing Tables (No Changes Needed)
| Table | Role in Finance |
|---|---|
| `subscription_payments` | Recurring revenue source (auto-generated) |
| `subscriptions` | Subscription metadata |
| `customers` | Customer reference for transactions |
| `customer_sites` | Site reference |
| `work_orders` | Optional link for one-time income |

### No Separate Tables For
- **Invoices** — invoice metadata (no, type, parasut_id) lives as columns on `financial_transactions`
- **VAT declarations** — computed as a VIEW/report, not stored
- **Withholding** — Phase 2, will be columns on `financial_transactions`

---

## 11. Phase Plan

### Phase 1 — MVP (Current Sprint)
| # | Feature | Priority |
|---|---|---|
| 1 | `financial_transactions` table + CRUD API | Must have |
| 2 | `expense_categories` table (10 defaults + custom) | Must have |
| 3 | Income entry form (one-time sales, services) | Must have |
| 4 | Expense entry form (quick entry optimized for 25-35/day) | Must have |
| 5 | VAT auto-calculation (official/unofficial toggle) | Must have |
| 6 | Currency support (USD/TRY dual storage) | Must have |
| 7 | `exchange_rates` table + manual TCMB rate entry | Must have |
| 8 | P&L dashboard (UNION subscriptions + transactions) | Must have |
| 9 | Monthly VAT summary report | Must have |
| 10 | Expense breakdown by category | Must have |

### Phase 2 — Iteration 1
| # | Feature |
|---|---|
| 1 | VAT withholding (tevkifat) — 9/10 for security services |
| 2 | Parasut API integration (auto-invoice generation) |
| 3 | Work order → invoice automation ("Generate Invoice" button) |
| 4 | TCMB API auto-sync (daily cron) |
| 5 | Collection tracking / accounts receivable aging |
| 6 | Bank reconciliation (manual matching) |
| 7 | Customer profitability analysis |
| 8 | Period comparison reports (month vs month, year vs year) |

### Phase 3 — Future
| # | Feature |
|---|---|
| 1 | Quote/teklif module |
| 2 | Full pipeline: quote → work order → invoice → financial record |
| 3 | Semi-automatic bank statement parsing (PDF upload + categorization) |
| 4 | Cash flow forecasting |
| 5 | Excel export for all reports |
| 6 | Advanced analytics / charts |

---

## 12. VAT Withholding (Phase 2 — Reference Only)

### Context (Documented for Later)
- Turkey security sector: 9/10 withholding ratio (tevkifat)
- Threshold: 15,000 TRY per invoice (2025 limit)
- Code: 607 (security services)
- Only applies to designated buyers (belirlenmiş alıcılar)

### CRITICAL: Correct Cash Flow
```
Service Invoice:         50,000 TRY
Output VAT (20%):        10,000 TRY
Invoice Total:           60,000 TRY  (shown on invoice)

Withholding (9/10):       9,000 TRY  (customer pays to tax office)
Company keeps (1/10):     1,000 TRY  (VAT you actually receive)

Customer pays YOU:       51,000 TRY  (NOT 60,000)
9,000 TRY withheld → becomes your asset (receivable from government)
```

### Future Fields (on financial_transactions)
```sql
withholding_applicable   BOOLEAN
withholding_rate         DECIMAL     -- 0.9 for 9/10
withholding_code         TEXT        -- '607'
withholding_amount       DECIMAL     -- computed: output_vat * withholding_rate
net_vat_collected        DECIMAL     -- output_vat - withholding_amount
```

### Per-Customer Flag (Future)
- `customers.is_withholding_agent` BOOLEAN
- When true: system auto-applies withholding on invoices above threshold
- Set once per customer, applied automatically

---

## 13. Accounting Principles Applied

### Accrual Basis (Tahakkuk Esasi)
- Transactions recorded when they OCCUR, not when cash moves
- Each transaction has a `period` (YYYY-MM) field
- Subscription: period = payment_month
- Expense: period = month the expense was incurred
- This gives correct P&L without full double-entry accounting

### Official vs Unofficial Separation
- Every transaction flagged as official or unofficial
- P&L shows total picture (both)
- VAT report only counts official transactions
- System never sends unofficial data to Parasut or accountant

### No Double-Entry
- This is NOT a full accounting system
- This is management accounting (yonetim muhasebesi)
- Single-entry ledger with smart views
- The accountant handles official books via Parasut data
- ERP handles internal decision-making data

---

## 14. UX Requirements

### Quick Entry (Critical for 35-50 entries/day)
- Form optimized for speed: tab-tab-tab-enter
- Smart defaults:
  - Date: today
  - Currency: TRY for expenses, USD for income (configurable)
  - VAT rate: 20%
  - Period: current month
- Recent categories remembered (most-used at top)
- After save: form resets but keeps date + category (for batch entry)
- Keyboard shortcut to open new entry

### List View
- Filterable by: date range, direction (income/expense), category, customer, official/unofficial
- Sortable by: date, amount, customer
- Searchable by: customer name, description, invoice_no
- Monthly totals at bottom

### Mobile Responsive
- Field technicians may enter expenses on phone
- Minimal fields on mobile: date, amount, category, payment method, photo (receipt)

---

## 15. Integration Points

### Existing ERP Modules → Finance
| Module | Feeds Into Finance | How |
|---|---|---|
| Subscriptions | Recurring revenue | `subscription_payments` table (auto) |
| SIM Cards | Rental revenue | Via subscription system (auto) |
| Work Orders | One-time revenue | Manual link via `work_order_id` (MVP) |
| Materials | COGS tracking | Material costs from work orders |
| Customers | Customer reference | `customer_id` on transactions |

### Finance → External Systems
| Target | Data | Phase |
|---|---|---|
| Parasut | Official invoices | Phase 2 |
| TCMB API | Exchange rates | Phase 1 (manual), Phase 2 (auto) |
| Excel Export | Reports | Phase 3 |

---

## 16. Success Criteria

### MVP Success (Phase 1)
- [ ] Replace daily Excel entries with ERP finance module
- [ ] All income and expenses trackable in one place
- [ ] VAT auto-calculated correctly (official/unofficial)
- [ ] P&L dashboard shows monthly profit/loss
- [ ] Expense categories working with custom additions
- [ ] USD/TRY currency support functional
- [ ] 35-50 entries/day manageable without frustration

### Overall Success
- [ ] Excel spreadsheet no longer needed
- [ ] Accountant receives data from Parasut (auto-generated)
- [ ] Monthly P&L available in one click
- [ ] VAT summary accurate and instant
- [ ] Historical comparison possible (month vs month)

---

**End of Requirements Specification**
